name: Mirror to GitLab

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to GitLab
        run: |
          if [ -z "$GITLAB_REPO" ]; then
            echo "‚ùå ERROR: GITLAB_REPO is not set!"
            exit 1
          fi

          if [ -z "$GITLAB_TOKEN" ]; then
            echo "‚ùå ERROR: GITLAB_TOKEN is not set!"
            exit 1
          fi

          echo "‚úÖ Mirroring to: gitlab.com/$GITLAB_REPO"

          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GITLAB_REPO}.git" || \
          git remote set-url gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GITLAB_REPO}.git"

          git push gitlab HEAD:main --tags || git push gitlab HEAD:main --force --tags

          echo "‚úÖ Successfully mirrored to GitLab"
          echo "üì¶ GitLab will build and deploy via .gitlab-ci.yml"
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_REPO: ${{ secrets.GITLAB_REPO }}
