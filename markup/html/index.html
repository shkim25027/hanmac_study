<!doctype html>
<html lang="ko">
  <head>
    <script>
      // 페이지 로드 시 실행
      if (!localStorage.getItem("startVisit")) {
        window.location.href = "./intro.html"; // intro 페이지 경로
      } else {
        // 접속일 갱신
        localStorage.setItem("lastVisit", new Date().toISOString());
      }
    </script>
    @@include("_include/_head.html")
    <link rel="stylesheet" type="text/css" href="./assets/css/main.min.css" />
  </head>
  <body>
    <div class="wrap main">
      @@include("_include/_header.html")
      <!-- container -->
      <div class="container">
        <div class="bg-circle">
          <ul>
            <li>
              <div></div>
            </li>
            <li></li>
            <li></li>
            <li></li>
          </ul>
        </div>
        <div class="main-contents">
          <div class="text-box">
            <span><em>홍길동</em> 선임연구원님</span>
            <div class="keyword-area">
              <button>나의 키워드 <i class="ico-setting"></i></button>
              <ul class="keyword-list">
                <li class="kw-allow">#인물</li>
                <li class="kw-allow active">#소통</li>
                <li class="kw-allow active">#협업</li>
                <li class="kw-deny active">#마인드셋</li>
                <li class="kw-deny">#웰니스</li>
              </ul>
            </div>
            <p><em>취향저격 영상 추천</em>드려요.</p>
          </div>

          <div class="video-wrap">
            <!-- 비디오 카드 컨테이너 -->
            <div class="video-cards-container" id="videoCardsContainer"></div>
            <!-- 네비게이션 버튼 -->
            <button class="btn-prev" id="prevBtn">‹</button>
            <button class="btn-next" id="nextBtn">›</button>
            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination">
              <span class="current">1</span> / 1
            </div>
          </div>
        </div>
      </div>
      <!-- // container -->
    </div>

    <script>
      // 전체 영상 데이터 (키워드 구분 없이)
      const allVideos = [
        {
          id: "IZm1m_FKmc0",
          category: "리더십",
          title: "정선근 교수가 알려주는 목디스크 지식",
          keywords: ["소통", "전문가"],
        },
        {
          id: "3CR-FmeOu2U",
          category: "인사이트",
          title: "기꺼이 '이 말'을 내 뱉을 줄 알아야 인정받는다",
          keywords: ["마인드셋", "자기개발"],
        },
        {
          id: "-X6GV6MvgSQ",
          category: "인사이트",
          title: "회계를 조금이라도 이해하면 인생이 달라집니다",
          keywords: ["소통", "코칭"],
        },
        {
          id: "-yRS3yGGnDU",
          category: "리더십",
          title: "성장하는 사람은 'OO 마인드'셋",
          keywords: ["마인드셋", "중간관리자"],
        },
        {
          id: "FUXT_m6nzhg",
          category: "인사이트",
          title: "정선근 교수가 알려주는 목디스크 지식",
          keywords: "소통 전문",
          keywords: ["소통", "전문"],
        },
        {
          id: "nLL409se8sM",
          category: "비즈트렌드",
          title: "3/2 - 이대호의 별책부록 [1조 여행 꿀팁]",
          keywords: ["동기부여", "AI"],
        },
        {
          id: "XKqLz6WJSRA",
          category: "팀워크",
          title: "효과적인 협업을 위한 5가지 원칙",
          keywords: ["협업", "전문가"],
        },
        {
          id: "3U0cbzmwSYc",
          category: "커뮤니케이션",
          title: "팀 생산성을 높이는 협업 도구",
          keywords: ["성장", "코칭"],
        },
        {
          id: "KE_MeQZgnPM",
          category: "리더십",
          title: "원격 근무 시대의 협업 전략",
          keywords: ["IT테크", "리더십"],
        },
        {
          id: "lnAo866WXgs",
          category: "인사이트",
          title: "갈등을 기회로 만드는 협업 기술",
          keywords: ["협업", "스킬업"],
        },
        {
          id: "wWcn4fRcVXI",
          category: "팀워크",
          title: "애자일 방식으로 일하는 법",
          keywords: ["성장", "코칭"],
        },
        {
          id: "wWcn4fRcVXI",
          category: "협업",
          title: "크로스펑셔널 팀 운영 노하우",
          keywords: ["팔로우십", "온보딩"],
        },
        {
          id: "2tKKgXcaXUg",
          category: "리더십",
          title: "2025년 리더가 갖춰야 할 역량",
          keywords: ["경영", "경제"],
        },
      ];

      // 현재 선택된 키워드들 (배열)
      let selectedKeywords = ["관찰"];

      // 페이지당 보여줄 영상 개수
      const VIDEOS_PER_PAGE = 6;

      // 현재 페이지
      let currentPage = 0;

      // 키워드에 맞는 영상 필터링 및 정렬 (매칭된 영상 우선, 나머지는 랜덤)
      function getFilteredAndSortedVideos() {
        if (selectedKeywords.length === 0) {
          return shuffleArray(allVideos); // 선택된 키워드가 없으면 전체 랜덤
        }

        // 매칭되는 영상과 매칭되지 않는 영상 분리
        const matchedVideos = [];
        const unmatchedVideos = [];

        allVideos.forEach((video) => {
          const hasMatch = video.keywords.some((keyword) =>
            selectedKeywords.includes(keyword)
          );
          if (hasMatch) {
            matchedVideos.push(video);
          } else {
            unmatchedVideos.push(video);
          }
        });

        // 매칭된 영상은 랜덤 섞기
        const shuffledMatched = shuffleArray(matchedVideos);

        // 매칭되지 않은 영상도 랜덤 섞기
        const shuffledUnmatched = shuffleArray(unmatchedVideos);

        // 매칭된 영상을 먼저 보여주고, 그 다음 나머지 영상
        return [...shuffledMatched, ...shuffledUnmatched];
      }

      // 전체 페이지 수 계산
      function getTotalPages() {
        const sortedVideos = getFilteredAndSortedVideos();
        return Math.ceil(sortedVideos.length / VIDEOS_PER_PAGE);
      }

      // 비디오 카드 생성
      function createVideoCard(video, index) {
        const card = document.createElement("div");
        card.className = "video-card";

        // keywords를 태그 형식으로 표시
        const keywordTags = video.keywords
          .map((kw) => `<span class="keyword-badge">${kw}</span>`)
          .join(" ");

        card.innerHTML = `
                <div class="thumbnail" >
                    <img src="https://img.youtube.com/vi/${video.id}/sddefault.jpg" />
                </div>
                <div class="txt-box">
                <div class="category">${video.category}</div>
                <div class="title">${video.title}</div>
                <div class="author">${keywordTags}</div>
                </div>
            `;

        return card;
      }

      // 현재 페이지의 영상 목록 가져오기
      function getCurrentPageVideos() {
        const sortedVideos = getFilteredAndSortedVideos();
        const startIndex = currentPage * VIDEOS_PER_PAGE;
        const endIndex = startIndex + VIDEOS_PER_PAGE;
        return sortedVideos.slice(startIndex, endIndex);
      }

      // 영상 목록 렌더링
      function renderVideos() {
        const container = document.getElementById("videoCardsContainer");
        const videos = getCurrentPageVideos();

        // 기존 카드 제거
        container.innerHTML = "";

        // 새 카드 생성 및 순차적 애니메이션
        videos.forEach((video, index) => {
          const card = createVideoCard(video, index);
          container.appendChild(card);

          // 순차적으로 나타나게 딜레이 추가
          setTimeout(() => {
            card.classList.add("show");
          }, index * 100);
        });

        // 페이지네이션 업데이트
        updatePagination();
      }

      // 페이지네이션 업데이트
      function updatePagination() {
        const pagination = document.getElementById("pagination");
        const totalPages = getTotalPages();

        pagination.innerHTML = `<span class="current">${currentPage + 1}</span> / ${totalPages}`;
      }

      // 배열 섞기 (Fisher-Yates 알고리즘)
      function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      }

      // 페이지 변경 (페이드 효과)
      async function changePage() {
        const cardsContainer = document.getElementById("videoCardsContainer");

        // 1. 페이드 아웃
        cardsContainer.classList.add("fade-out");

        // 2. 페이드 아웃 완료 대기
        await new Promise((resolve) => setTimeout(resolve, 400));

        // 3. 새로운 영상 목록 렌더링
        renderVideos();

        // 4. 페이드 인
        cardsContainer.classList.remove("fade-out");
      }

      // 네비게이션 버튼 이벤트
      document.getElementById("prevBtn").addEventListener("click", async () => {
        if (currentPage > 0) {
          currentPage--;
          await changePage();
        }
      });

      document.getElementById("nextBtn").addEventListener("click", async () => {
        const totalPages = getTotalPages();
        if (currentPage < totalPages - 1) {
          currentPage++;
          await changePage();
        }
      });

      // 키워드 태그 클릭 이벤트
      document.querySelectorAll(".keyword-list > li").forEach((tag) => {
        tag.addEventListener("click", async function () {
          const keyword = this.dataset.keyword;

          // 토글 방식으로 동작
          if (this.classList.contains("active")) {
            // 이미 선택된 키워드면 제거
            this.classList.remove("active");
            selectedKeywords = selectedKeywords.filter((k) => k !== keyword);
          } else {
            // 선택되지 않은 키워드면 추가
            this.classList.add("active");
            selectedKeywords.push(keyword);
          }

          // 페이지를 첫 페이지로 리셋
          currentPage = 0;

          // 페이드 효과와 함께 영상 변경
          await changePage();
        });
      });

      // 초기 렌더링
      renderVideos();
    </script>
  </body>
</html>
