<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>학습 진행률 게이지 - 최종 (핀 포함)</title>
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
    <style>
      .learning-gauge {
        width: 100%;
        overflow: hidden;
      }
      .learning-gauge svg {
        display: block;
        width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="wrap learning">
      <!-- container -->
      <div class="container">
        <div class="page-title">
          <h3>
            <em>홍길동 선임연구원님</em>
          </h3>
          <p>
            <em>D-66<small>(3월 20일)</small> 까지 필수 콘텐츠</em> 시청을
            완료해주세요.
          </p>
        </div>

        <div class="learning-area">
          <div class="learning-gauge" id="gaugeContainer">
            <!-- SVG가 여기에 삽입됩니다 -->
          </div>
        </div>
      </div>

      <!-- // container -->
    </div>
    <script>
      // SVG 파일을 fetch로 불러와서 삽입
      fetch("./assets/images/learning/bg_line.svg")
        .then((response) => response.text())
        .then((svgText) => {
          const container = document.getElementById("gaugeContainer");
          container.innerHTML = svgText;

          // progressMask를 SVG에 추가
          const svg = container.querySelector("svg");
          if (!svg) {
            console.error("SVG not found");
            return;
          }

          // defs 찾기
          let defs = svg.querySelector("defs");
          if (!defs) {
            defs = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "defs"
            );
            svg.insertBefore(defs, svg.firstChild);
          }

          // progressMask 추가
          const maskHTML = `
            <mask id="progressMask">
              <path id="maskPath"
                d="M -395.968 571.68 C -395.968 571.68 1436.35 647.6 1436.35 498.446 C 1433.53 304.242 143.586 386.337 143.586 289.767 C 143.586 182.271 1240.47 267.705 1240.47 184.273 C 1240.47 116.048 337.589 141.885 337.589 105.112 C 337.589 76.3325 744.888 70 744.888 70 H 745.8 C 745.8 70 341.757 78.7307 341.757 105.112"
                fill="none"
                stroke="white"
                stroke-width="80"
                stroke-linecap="round"
                stroke-linejoin="round"/>
            </mask>
          `;

          defs.insertAdjacentHTML("beforeend", maskHTML);

          // 진행 경로에 progressMask 적용
          const progressGroups = svg.querySelectorAll(
            'g[mask*="mask1"], g[mask*="mask3"]'
          );
          progressGroups.forEach((g) => {
            // 기존 mask 유지하면서 새로운 mask도 적용하기 위해
            // 내부에 또 다른 g를 만들어서 progressMask 적용
            const innerG = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "g"
            );
            innerG.setAttribute("mask", "url(#progressMask)");

            // 기존 자식들을 innerG로 이동
            while (g.firstChild) {
              innerG.appendChild(g.firstChild);
            }
            g.appendChild(innerG);
          });

          // 진행률 제어 함수
          const maskPath = svg.querySelector("#maskPath");
          let pathLength = 0;

          function setProgress(percent) {
            if (!maskPath) {
              console.error("maskPath not found!");
              return;
            }

            const p = percent / 100;

            // 경로 길이 계산 (첫 호출시)
            if (pathLength === 0) {
              pathLength = maskPath.getTotalLength();
              maskPath.style.strokeDasharray = pathLength;
              maskPath.style.strokeDashoffset = pathLength;
            }

            // 선을 따라 채우기
            const offset = pathLength * (1 - p);
            maskPath.style.strokeDashoffset = offset;

            console.log(
              `Progress: ${percent}%, pathLength: ${pathLength}, offset: ${offset}`
            );
          }

          // 전역 함수로 등록
          window.updateProgress = setProgress;

          // 초기 설정
          console.log("SVG loaded and ready");
          setProgress(30); // 30%로 시작
        })
        .catch((error) => {
          console.error("Error loading SVG:", error);
        });
    </script>
  </body>
</html>
