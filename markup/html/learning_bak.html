<!doctype html>
<html lang="ko">
  <head>
    @@include("_include/_head.html")
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
  </head>
  <body>
    <div class="wrap learning">
      @@include("_include/_header.html")
      <!-- container -->
      <div class="container">
        <div class="learning-wrap">
          <div class="page-title">
            <h3>
              <em>홍길동 선임연구원님</em>
            </h3>
            <p>
              <em>D-66<small>(3월 20일)</small> 까지 필수 콘텐츠</em> 시청을
              완료해주세요.
            </p>
          </div>
          <div class="learning-area">
            <div class="learning-gauge">
              <div class="start-line"></div>
              @@include("./learning_svg.html")
              <div class="chapter"></div>
              <div id="markers-container"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- // container -->
    </div>
    <script>
      let markers = [];
      let pathLength = 0;
      let currentModal = null;
      let currentLearningIndex = null; // 현재 학습 중인 인덱스
      const maskPath = document.getElementById("maskPath");
      const gaugeSvg = document.getElementById("gauge-svg");
      const markersContainer = document.getElementById("markers-container");

      // 마커 설정
      const markerConfigs = [
        {
          pathPercent: 0.108,
          type: "chapter",
          label: "챕터1-1",
          url: "OXTYn3JkkCQ",
          completed: true,
        },
        {
          pathPercent: 0.137,
          type: "normal",
          label: "1-2단계",
          url: "OXTYn3JkkCQ",
          completed: true,
        },
        {
          pathPercent: 0.159,
          type: "normal",
          label: "1-3단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.182,
          type: "normal",
          label: "1-4단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.205,
          type: "normal",
          label: "1-5단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.228,
          type: "normal",
          label: "1-6단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.25,
          type: "normal",
          label: "1-7단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.272,
          type: "normal",
          label: "1-8단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.298,
          type: "normal",
          label: "1-9단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.325,
          type: "chapter",
          label: "챕터2-1",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.367,
          type: "normal",
          label: "2-2단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.41,
          type: "normal",
          label: "2-3단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.442,
          type: "chapter",
          label: "챕터3-1",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.486,
          type: "normal",
          label: "3-2단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.531,
          type: "normal",
          label: "3-3단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.555,
          type: "chapter",
          label: "챕터4-1",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.585,
          type: "normal",
          label: "4-2단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.635,
          type: "normal",
          label: "4-3단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.67,
          type: "chapter",
          label: "챕터5-1",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.69,
          type: "normal",
          label: "5-2단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.718,
          type: "normal",
          label: "5-3단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.736,
          type: "normal",
          label: "5-4단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.785,
          type: "normal",
          label: "5-5단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.82,
          type: "normal",
          label: "5-6단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
        {
          pathPercent: 0.86,
          type: "normal",
          label: "5-7단계",
          url: "OXTYn3JkkCQ",
          completed: false,
        },
      ];

      // SVG 이미지 경로
      const markerImages = {
        normal: {
          base: "./assets/images/learning/mark_base.svg",
          current: "./assets/images/learning/mark_current.svg",
          completed: "./assets/images/learning/mark_completed.svg",
        },
        chapter: {
          base: "./assets/images/learning/mark_chapter_base.svg",
          current: "./assets/images/learning/mark_chapter_current.svg",
          completed: "./assets/images/learning/mark_chapter_completed.svg",
        },
      };

      // 진행률 설정
      function setProgress(percent) {
        if (!maskPath) return;

        const p = percent / 100;
        if (pathLength === 0) {
          pathLength = maskPath.getTotalLength();
          maskPath.style.strokeDasharray = pathLength;
          maskPath.style.strokeDashoffset = pathLength;
        }

        const offset = pathLength * (1 - p);
        maskPath.style.strokeDashoffset = offset;
        updateMarkers(percent);
      }

      function getPointAtPercent(percent) {
        if (!pathLength) pathLength = maskPath.getTotalLength();
        return maskPath.getPointAtLength(pathLength * percent);
      }

      // 마커 생성
      function createMarkers() {
        const svgRect = gaugeSvg.getBoundingClientRect();
        const viewBox = gaugeSvg.viewBox.baseVal;
        const scaleX = svgRect.width / viewBox.width;
        const scaleY = svgRect.height / viewBox.height;

        markerConfigs.forEach((config, index) => {
          const point = getPointAtPercent(config.pathPercent);
          const marker = document.createElement("div");
          marker.className = "marker";
          if (config.type === "chapter") marker.classList.add("chapter");

          marker.dataset.index = index;
          marker.dataset.type = config.type;
          marker.dataset.percent = config.pathPercent;

          const img = document.createElement("img");
          img.style.height = "auto";
          marker.appendChild(img);
          markersContainer.appendChild(marker);

          marker.style.left = point.x * scaleX + "px";
          marker.style.top = point.y * scaleY + "px";

          // 마커 클릭 가능 여부 확인
          const isClickable = isMarkerClickable(index);

          if (!isClickable) {
            marker.style.cursor = "not-allowed";
            marker.classList.add("disabled");
          } else {
            marker.style.cursor = "pointer";
            marker.classList.add("has-click-event");
            // 마커 클릭 이벤트
            marker.addEventListener("click", () =>
              loadVideoModal(config, index)
            );
          }

          markers.push({
            element: marker,
            img: img,
            config: config,
            point: point,
          });
        });
      }

      // 마커 상태 업데이트
      function updateMarkers(progress) {
        markers.forEach((marker, index) => {
          const config = marker.config;
          let imgSrc;

          if (config.completed) {
            // 완료된 학습
            imgSrc =
              config.type === "normal"
                ? markerImages.normal.completed
                : markerImages.chapter.completed;
          } else if (isMarkerClickable(index) && !config.completed) {
            // 현재 학습 가능한 마커 (다음에 해야 할 학습)
            imgSrc =
              config.type === "normal"
                ? markerImages.normal.current
                : markerImages.chapter.current;
          } else {
            // 아직 잠긴 마커 (비활성)
            imgSrc =
              config.type === "normal"
                ? markerImages.normal.base
                : markerImages.chapter.base;
          }
          marker.img.src = imgSrc;
        });
      }

      // 마커 클릭 가능 여부 확인
      function isMarkerClickable(index) {
        // 첫 번째는 항상 클릭 가능
        if (index === 0) return true;

        // 이전 학습이 완료되었는지 확인
        return markerConfigs[index - 1].completed;
      }

      // 기존 모달 제거
      function destroyModal() {
        if (currentModal) {
          currentModal.remove();
          currentModal = null;
        }
      }

      // Ajax로 비디오 모달 로드
      async function loadVideoModal(videoData, currentIndex) {
        try {
          // 기존 모달이 있으면 제거
          destroyModal();

          // 현재 학습 인덱스 저장
          currentLearningIndex = currentIndex;

          const modalType = videoData.type || "learning";
          const modalPath = "./_modal/video-learning.html";

          const response = await fetch(`${modalPath}?t=${Date.now()}`);
          if (!response.ok) {
            throw new Error(`모달 로드 실패: ${modalPath}`);
          }

          const modalHTML = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(modalHTML, "text/html");

          const modalElement = doc.querySelector(".modal.video");
          if (!modalElement) {
            throw new Error("모달 요소를 찾을 수 없습니다");
          }

          modalElement.id = "videoModal";
          modalElement.setAttribute("data-type", modalType);

          // DOM에 먼저 추가
          document.body.appendChild(modalElement);
          currentModal = modalElement;

          // iframe에 비디오 URL 설정
          const iframe = modalElement.querySelector("#videoFrame");
          if (iframe) {
            iframe.src = `https://www.youtube.com/embed/${videoData.url}?autoplay=1`;
          }

          // 모달 컨텐츠 업데이트
          updateModalContent(modalElement, videoData, currentIndex);

          // 모달 표시 및 이벤트 설정 (충분한 지연시간 확보)
          setTimeout(() => {
            modalElement.style.display = "block";
            // display 후 브라우저 렌더링 대기
            setTimeout(() => {
              setupModalCloseEvents(modalElement);
            }, 100);
          }, 50);
        } catch (error) {
          console.error("모달 로드 오류:", error);
          alert("비디오를 로드하는 중 오류가 발생했습니다.");
        }
      }

      // 모달 컨텐츠 업데이트
      function updateModalContent(modalElement, videoData, currentIndex) {
        // 비디오 제목 업데이트
        const videoTitle = modalElement.querySelector(".tit-box h3");
        const currentLesson = modalElement.querySelector(".sub-txt");

        if (videoTitle) videoTitle.textContent = videoData.label;
        if (currentLesson) currentLesson.textContent = videoData.label;

        // 진행률 계산
        const completedCount = markerConfigs.filter((m) => m.completed).length;
        const totalCount = markerConfigs.length;
        const progressPercent = Math.round((completedCount / totalCount) * 100);

        // 게이지 업데이트
        const gaugeFill = modalElement.querySelector("#gaugeFill");
        const currentStep = modalElement.querySelector(
          ".gauge-labels .label em"
        );
        const progressText = modalElement.querySelector(
          ".gauge-labels .current em"
        );

        if (gaugeFill) gaugeFill.style.width = progressPercent + "%";
        if (currentStep) currentStep.textContent = currentIndex + 1;
        if (progressText) progressText.textContent = progressPercent;

        // 학습 목차 생성
        createLearningList(modalElement, currentIndex);
      }

      // 학습 목차 생성
      function createLearningList(modalElement, currentIndex) {
        const list = modalElement.querySelector(".learning-list");
        if (!list) return;

        list.innerHTML = "";

        markerConfigs.forEach((config, index) => {
          const li = document.createElement("li");
          const isClickable = isMarkerClickable(index);

          if (config.completed) {
            li.className = "complet";
          } else if (index === currentIndex) {
            li.className = "active";
          }

          // 클릭 불가능한 항목에 disabled 클래스 추가
          if (!isClickable) {
            li.classList.add("disabled");
            li.style.opacity = "0.5";
            li.style.cursor = "not-allowed";
          }

          li.innerHTML = `
      <a href="#" class="list" data-index="${index}">
        <span class="seq">${index + 1}차시</span>
        <div class="learning-box">
          <div class="thumb">
            <img src="./assets/images/video/img_learning_thumb_0${(index % 6) + 1}.png" />
          </div>
          <div class="txt-box">
            <div class="title">${config.label}</div>
            <spna class="state">${config.completed ? "학습완료" : index === currentIndex ? "학습중" : "미진행"}</spna>
          </div>
        </div>
      </a>
    `;

          // 목차 클릭 이벤트 (클릭 가능한 경우만)
          if (isClickable) {
            li.querySelector(".list").addEventListener("click", (e) => {
              e.preventDefault();
              const clickedIndex = parseInt(e.currentTarget.dataset.index);
              loadVideoModal(markerConfigs[clickedIndex], clickedIndex);
            });
          } else {
            li.querySelector(".list").addEventListener("click", (e) => {
              e.preventDefault();
            });
          }

          list.appendChild(li);
        });
      }

      // 모달 닫기 이벤트 설정
      function setupModalCloseEvents(modalElement) {
        const closeBtn = modalElement.querySelector(".close");
        if (closeBtn) {
          closeBtn.onclick = () => closeVideoModal();
        }

        modalElement.onclick = (e) => {
          if (e.target === modalElement) closeVideoModal();
        };
      }

      // 모달 닫기
      function closeVideoModal() {
        if (!currentModal) return;

        const iframe = currentModal.querySelector("#videoFrame");

        // 비디오 정지
        if (iframe) iframe.src = "";

        // 모달 숨김
        currentModal.style.display = "none";

        // 학습 완료 처리
        if (currentLearningIndex !== null) {
          completeLesson(currentLearningIndex);
          currentLearningIndex = null;
        }
      }

      // 학습 완료 처리
      function completeLesson(index) {
        // 해당 학습을 완료로 표시
        markerConfigs[index].completed = true;

        // 다음 학습 가능한 마커의 위치로 진행률 설정
        const nextIndex = index + 1;
        let progressPercent;

        if (nextIndex < markerConfigs.length) {
          // 다음 마커의 pathPercent를 진행률로 사용
          progressPercent = markerConfigs[nextIndex].pathPercent * 100;
        } else {
          // 마지막 학습 완료 시 100%
          progressPercent = 100;
        }

        // 진행률 업데이트
        setProgress(progressPercent);

        // 마커 상태 업데이트
        updateMarkers(progressPercent);

        // 다음 마커 클릭 가능하도록 업데이트
        updateMarkerClickability();

        const completedCount = markerConfigs.filter((m) => m.completed).length;
        const totalCount = markerConfigs.length;
        console.log(
          `학습 ${index + 1} 완료! (${completedCount}/${totalCount}) 진행률: ${progressPercent.toFixed(1)}%`
        );
      }

      // 마커 클릭 가능 여부 업데이트
      function updateMarkerClickability() {
        markers.forEach((marker, index) => {
          const isClickable = isMarkerClickable(index);
          const element = marker.element;
          const config = marker.config;

          if (config.completed) {
            // 완료된 마커 - 클릭 가능하지만 시각적으로 완료 표시
            element.style.opacity = "1";
            element.style.cursor = "pointer";
            element.classList.remove("disabled");
          } else if (isClickable) {
            // 현재 학습 가능한 마커 (current)
            element.style.opacity = "1";
            element.style.cursor = "pointer";
            element.classList.remove("disabled");

            // 이미 이벤트가 있는지 확인하고 없으면 추가
            if (!element.classList.contains("has-click-event")) {
              element.classList.add("has-click-event");
              element.addEventListener("click", () =>
                loadVideoModal(marker.config, index)
              );
            }
          } else {
            // 비활성 마커 (base)
            element.style.opacity = "0.5";
            element.style.cursor = "not-allowed";
            element.classList.add("disabled");
          }
        });
      }

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (currentModal && currentModal.style.display === "block") {
            closeVideoModal();
          }
        }
      });

      // 초기 진행률 계산
      function calculateInitialProgress() {
        // 완료된 마커 개수 확인
        const completedCount = markerConfigs.filter((m) => m.completed).length;

        if (completedCount === 0) {
          // 완료된 것이 없으면 첫 번째 마커 위치
          return markerConfigs[0].pathPercent * 100;
        } else if (completedCount >= markerConfigs.length) {
          // 모두 완료되면 100%
          return 100;
        } else {
          // 완료된 다음 마커(현재 학습해야 할 마커) 위치
          return markerConfigs[completedCount].pathPercent * 100;
        }
      }

      // 초기화
      window.addEventListener("DOMContentLoaded", () => {
        createMarkers();

        // 초기 진행률: 완료된 학습 기준으로 설정
        const initialProgress = calculateInitialProgress();
        setProgress(initialProgress);
      });
    </script>
  </body>
</html>
