<!doctype html>
<html lang="ko">
  <head>
    <script>
      // 페이지 로드 시 실행
      if (!localStorage.getItem("startVisit")) {
        window.location.href = "./intro.html"; // intro 페이지 경로
      } else {
        // 접속일 갱신
        localStorage.setItem("lastVisit", new Date().toISOString());
      }
    </script>
    @@include("_include/_head.html")
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
  </head>
  <body>
    <div class="wrap main">
      @@include("_include/_header.html")
      <!-- container -->
      <div class="container">
        <div class="bg-circle">
          <ul>
            <li>
              <div></div>
            </li>
            <li></li>
            <li></li>
            <li></li>
          </ul>
        </div>
        <div class="main-contents">
          <div class="text-box">
            <span><em>홍길동</em> 선임연구원님</span>
            <div class="keyword-area">
              <button id="keywordSettingsBtn">
                나의 키워드 <i class="ico-setting"></i>
              </button>
              <div class="keyword-list" id="myKeyword">
                <label class="kw-allow" for="chk1">
                  <input type="checkbox" id="chk1" />
                  #인물
                </label>
                <label class="kw-allow" for="chk2">
                  <input type="checkbox" id="chk2" checked />
                  #소통
                </label>
                <label class="kw-allow" for="chk3">
                  <input type="checkbox" id="chk3" checked />
                  #협업
                </label>
                <label class="kw-deny" for="chk4">
                  <input type="checkbox" id="chk4" checked />
                  #마인드셋
                </label>
                <label class="kw-deny" for="chk5">
                  <input type="checkbox" id="chk5" />
                  #웰니스
                </label>
              </div>
            </div>
            <p><em>취향저격 영상 추천</em>드려요.</p>
          </div>

          <div class="video-wrap">
            <!-- 비디오 카드 컨테이너 -->
            <div class="video-cards-container" id="videoCardsContainer"></div>
            <!-- 네비게이션 버튼 -->
            <button class="btn-prev" id="prevBtn">‹</button>
            <button class="btn-next" id="nextBtn">›</button>
            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination">
              <span class="current">1</span> / 1
            </div>
          </div>

          <!-- // keyword modal-->
          <div class="modal keyword" id="keywordModal">
            <div class="modal-content">
              <div class="modal-header">
                나의 키워드 수정<i class="ico-check"></i>
              </div>
              <div class="modal-body" id="modalBody">
                <ul class="keyword-tag">
                  <li class="kw-box">
                    <label for="kwtag_1">
                      <input type="checkbox" id="kwtag_1" disabled /> #온보딩
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_2">
                      <input type="checkbox" id="kwtag_2" disabled /> #성장
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_3">
                      <input type="checkbox" id="kwtag_3" disabled /> #코칭
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_4">
                      <input type="checkbox" id="kwtag_4" /> #인물
                    </label>
                    <input type="checkbox" class="kw-add" checked />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_5">
                      <input type="checkbox" id="kwtag_5" checked /> #소통
                    </label>
                    <input type="checkbox" class="kw-add" checked />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_6">
                      <input type="checkbox" id="kwtag_6" checked /> #협업
                    </label>
                    <input type="checkbox" class="kw-add" checked />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_7">
                      <input type="checkbox" id="kwtag_7" disabled /> AI
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_8">
                      <input type="checkbox" id="kwtag_8" disabled /> IT테크
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_9">
                      <input type="checkbox" id="kwtag_9" disabled />
                      #중간관리자
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_10">
                      <input type="checkbox" id="kwtag_10" disabled /> #리더십
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_11">
                      <input type="checkbox" id="kwtag_11" disabled /> #팔로우십
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_12">
                      <input type="checkbox" id="kwtag_12" disabled /> #동기부여
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_13">
                      <input type="checkbox" id="kwtag_13" disabled /> #인간관계
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_14">
                      <input type="checkbox" id="kwtag_14" disabled /> #스킬업
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_15">
                      <input type="checkbox" id="kwtag_15" disabled /> #피드백
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_16">
                      <input type="checkbox" id="kwtag_16" disabled /> #커리어
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_17">
                      <input type="checkbox" id="kwtag_17" disabled /> #경영
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                  <li class="kw-box">
                    <label for="kwtag_18">
                      <input type="checkbox" id="kwtag_18" disabled /> #경제
                    </label>
                    <input type="checkbox" class="kw-add" />
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <!-- // keyword modal-->
        </div>
      </div>
      <!-- // container -->
    </div>

    <script src="../assets/js/kw_tag.js"></script>
    <script>
      // 전체 영상 데이터 (키워드 구분 없이)
      const allVideos = [
        {
          id: "IZm1m_FKmc0",
          category: "리더십",
          title: "정선근 교수가 알려주는 목디스크 지식",
          keywords: ["소통", "전문가"],
        },
        {
          id: "3CR-FmeOu2U",
          category: "인사이트",
          title: "기꺼이 '이 말'을 내 뱉을 줄 알아야 인정받는다",
          keywords: ["마인드셋", "자기개발"],
        },
        {
          id: "-X6GV6MvgSQ",
          category: "인사이트",
          title: "회계를 조금이라도 이해하면 인생이 달라집니다",
          keywords: ["소통", "코칭"],
        },
        {
          id: "-yRS3yGGnDU",
          category: "리더십",
          title: "성장하는 사람은 'OO 마인드'셋",
          keywords: ["마인드셋", "중간관리자"],
        },
        {
          id: "FUXT_m6nzhg",
          category: "인사이트",
          title: "정선근 교수가 알려주는 목디스크 지식",
          keywords: "소통 전문",
          keywords: ["소통", "전문"],
        },
        {
          id: "nLL409se8sM",
          category: "비즈트렌드",
          title: "3/2 - 이대호의 별책부록 [1조 여행 꿀팁]",
          keywords: ["동기부여", "AI"],
        },
        {
          id: "XKqLz6WJSRA",
          category: "리더십",
          title: "효과적인 협업을 위한 5가지 원칙",
          keywords: ["협업", "전문가"],
        },
        {
          id: "3U0cbzmwSYc",
          category: "인사이트",
          title: "팀 생산성을 높이는 협업 도구",
          keywords: ["성장", "코칭"],
        },
        {
          id: "KE_MeQZgnPM",
          category: "리더십",
          title: "원격 근무 시대의 협업 전략",
          keywords: ["IT테크", "리더십"],
        },
        {
          id: "lnAo866WXgs",
          category: "인사이트",
          title: "갈등을 기회로 만드는 협업 기술",
          keywords: ["협업", "스킬업"],
        },
        {
          id: "wWcn4fRcVXI",
          category: "비즈트렌드",
          title: "애자일 방식으로 일하는 법",
          keywords: ["성장", "코칭"],
        },
        {
          id: "wWcn4fRcVXI",
          category: "비즈트렌드",
          title: "크로스펑셔널 팀 운영 노하우",
          keywords: ["팔로우십", "온보딩"],
        },
        {
          id: "2tKKgXcaXUg",
          category: "리더십",
          title: "2025년 리더가 갖춰야 할 역량",
          keywords: ["경영", "경제"],
        },
      ];

      // 현재 선택된 키워드들 (배열)
      let selectedKeywords = ["소통", "협업", "마인드셋"];

      // 페이지당 보여줄 영상 개수
      const VIDEOS_PER_PAGE = 6;

      // 현재 페이지
      let currentPage = 0;

      // 키워드에 맞는 영상 필터링 및 정렬 (매칭된 영상 우선, 나머지는 랜덤)
      function getFilteredAndSortedVideos() {
        if (selectedKeywords.length === 0) {
          return shuffleArray(allVideos); // 선택된 키워드가 없으면 전체 랜덤
        }

        // 매칭되는 영상과 매칭되지 않는 영상 분리
        const matchedVideos = [];
        const unmatchedVideos = [];

        allVideos.forEach((video) => {
          const hasMatch = video.keywords.some((keyword) =>
            selectedKeywords.includes(keyword)
          );
          if (hasMatch) {
            matchedVideos.push(video);
          } else {
            unmatchedVideos.push(video);
          }
        });

        // 매칭된 영상은 랜덤 섞기
        const shuffledMatched = shuffleArray(matchedVideos);

        // 매칭되지 않은 영상도 랜덤 섞기
        const shuffledUnmatched = shuffleArray(unmatchedVideos);

        // 매칭된 영상을 먼저 보여주고, 그 다음 나머지 영상
        return [...shuffledMatched, ...shuffledUnmatched];
      }

      // 전체 페이지 수 계산
      function getTotalPages() {
        const sortedVideos = getFilteredAndSortedVideos();
        return Math.ceil(sortedVideos.length / VIDEOS_PER_PAGE);
      }

      // 비디오 카드 생성
      function createVideoCard(video, index) {
        const card = document.createElement("div");
        card.className = "video-card";

        // keywords를 태그 형식으로 표시
        const keywordTags = video.keywords
          .map((kw) => `<span class="key-badge">${kw}</span>`)
          .join(" ");

        // 카테고리에 따른 클래스명 매핑
        const categoryClassMap = {
          리더십: "leader",
          인사이트: "insight",
          비즈트렌드: "biz",
        };

        const categoryClass = categoryClassMap[video.category] || "default";

        card.innerHTML = `
                <div class="thumbnail" >
                    <img src="https://img.youtube.com/vi/${video.id}/sddefault.jpg" />
                </div>
                <div class="txt-box">
                <div class="category  ${categoryClass}">${video.category}</div>
                <div class="title">${video.title}</div>
                <div class="author">${keywordTags}</div>
                </div>
            `;

        return card;
      }

      // 현재 페이지의 영상 목록 가져오기
      function getCurrentPageVideos() {
        const sortedVideos = getFilteredAndSortedVideos();
        const startIndex = currentPage * VIDEOS_PER_PAGE;
        const endIndex = startIndex + VIDEOS_PER_PAGE;
        return sortedVideos.slice(startIndex, endIndex);
      }

      // 영상 목록 렌더링
      function renderVideos() {
        const container = document.getElementById("videoCardsContainer");
        const videos = getCurrentPageVideos();

        // 기존 카드 제거
        container.innerHTML = "";

        // 새 카드 생성 및 순차적 애니메이션
        videos.forEach((video, index) => {
          const card = createVideoCard(video, index);
          container.appendChild(card);

          // 순차적으로 나타나게 딜레이 추가
          setTimeout(() => {
            card.classList.add("show");
          }, index * 100);
        });

        // 페이지네이션 업데이트
        updatePagination();
      }

      // 버튼 상태 업데이트 함수
      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const totalPages = getTotalPages();

        // 이전 버튼 상태
        if (currentPage === 0) {
          prevBtn.classList.add("disabled");
        } else {
          prevBtn.classList.remove("disabled");
        }

        // 다음 버튼 상태
        if (currentPage >= totalPages - 1) {
          nextBtn.classList.add("disabled");
        } else {
          nextBtn.classList.remove("disabled");
        }
      }

      // 페이지네이션 업데이트
      function updatePagination() {
        const pagination = document.getElementById("pagination");
        const totalPages = getTotalPages();

        pagination.innerHTML = `<span class="current">${currentPage + 1}</span> / ${totalPages}`;

        // 버튼 상태 업데이트 추가
        updateNavigationButtons();
      }

      // 배열 섞기 (Fisher-Yates 알고리즘)
      function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      }

      // 페이지 변경 (페이드 효과)
      async function changePage() {
        const cardsContainer = document.getElementById("videoCardsContainer");

        // 1. 페이드 아웃
        cardsContainer.classList.add("fade-out");

        // 2. 페이드 아웃 완료 대기
        await new Promise((resolve) => setTimeout(resolve, 400));

        // 3. 새로운 영상 목록 렌더링
        renderVideos();

        // 4. 페이드 인
        cardsContainer.classList.remove("fade-out");
      }

      // 네비게이션 버튼 이벤트
      document.getElementById("prevBtn").addEventListener("click", async () => {
        if (currentPage > 0) {
          currentPage--;
          await changePage();
        }
      });

      document.getElementById("nextBtn").addEventListener("click", async () => {
        const totalPages = getTotalPages();
        if (currentPage < totalPages - 1) {
          currentPage++;
          await changePage();
        }
      });

      // 키워드 체크박스 변경 이벤트
      document
        .querySelectorAll("#myKeyword input[type='checkbox']")
        .forEach((checkbox) => {
          checkbox.addEventListener("change", async function () {
            const label = this.closest("label");
            const keywordText = label.textContent.trim().replace("#", "");

            // 체크박스 상태에 따라 키워드 추가/제거
            if (this.checked) {
              // 체크되면 키워드 추가
              if (!selectedKeywords.includes(keywordText)) {
                selectedKeywords.push(keywordText);
              }
            } else {
              // 체크 해제되면 키워드 제거
              selectedKeywords = selectedKeywords.filter(
                (k) => k !== keywordText
              );
            }

            // 페이지를 첫 페이지로 리셋
            currentPage = 0;

            // 페이드 효과와 함께 영상 변경
            await changePage();
          });
        });

      // 초기 렌더링
      renderVideos();
    </script>

    <script>
      // 모달 관련 기능
      const keywordModal = document.getElementById("keywordModal");
      const keywordSettingsBtn = document.getElementById("keywordSettingsBtn");
      const modalClose = document.getElementById("modalClose");

      // 모달 열기
      keywordSettingsBtn.addEventListener("click", () => {
        keywordModal.style.display = "block";
      });

      // 모달 닫기
      /*
            modalClose.addEventListener("click", () => {
              keywordModal.style.display = "none";
            });
      */
      // 모달 외부 클릭 시 닫기
      keywordModal.addEventListener("click", (e) => {
        if (e.target === keywordModal) {
          syncKeywordsToList();
          keywordModal.style.display = "none";
        }
      });

      // 모달 내 키워드 태그 클릭
      document.querySelectorAll(".modal-keyword-tag > li").forEach((tag) => {
        tag.addEventListener("click", function () {
          this.classList.toggle("selected");

          const keyword = this.dataset.keyword;

          // 중앙 원의 태그들과 동기화
          const centerTag = document.querySelector(
            `.tag[data-keyword="${keyword}"]`
          );
          if (centerTag) {
            if (this.classList.contains("selected")) {
              centerTag.classList.add("active");
              if (!selectedKeywords.includes(keyword)) {
                selectedKeywords.push(keyword);
              }
            } else {
              centerTag.classList.remove("active");
              selectedKeywords = selectedKeywords.filter((k) => k !== keyword);
            }
          } else {
            // 중앙 원에 없는 새로운 키워드
            if (this.classList.contains("selected")) {
              if (!selectedKeywords.includes(keyword)) {
                selectedKeywords.push(keyword);
              }
            } else {
              selectedKeywords = selectedKeywords.filter((k) => k !== keyword);
            }
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        keywordChange();
      });
    </script>
  </body>
</html>
